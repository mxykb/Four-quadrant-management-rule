# æ•°æ®ç»Ÿè®¡é¡µé¢ - æ•°æ®ç»‘å®šå’ŒçŠ¶æ€ç®¡ç†å®ç°æ–‡æ¡£

## ğŸ¯ å®ç°æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†æ•°æ®ç»Ÿè®¡é¡µé¢çš„æ•°æ®ç»‘å®šå’ŒçŠ¶æ€ç®¡ç†å®ç°ï¼ŒåŒ…æ‹¬ViewModelçŠ¶æ€ç®¡ç†ã€æ•°æ®æµå‘ã€æ—¶é—´èŒƒå›´åˆ‡æ¢å’Œä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½ã€‚

## ğŸ“Š ViewModelçŠ¶æ€ç®¡ç†æ¶æ„

### 1. çŠ¶æ€æ•°æ®åˆ†ç±»

```java
public class StatisticsViewModel extends ViewModel {
    // é¡µé¢çŠ¶æ€æ•°æ® - ç»†åˆ†ç®¡ç†
    private MutableLiveData<StatisticsData> kpiData;                    // KPIæŒ‡æ ‡æ•°æ®
    private MutableLiveData<List<CompletionTrend>> taskTrendData;       // ä»»åŠ¡è¶‹åŠ¿æ•°æ®
    private MutableLiveData<List<QuadrantDistribution>> quadrantData;   // å››è±¡é™åˆ†å¸ƒæ•°æ®
    private MutableLiveData<List<PomodoroDistribution>> pomodoroData;   // ç•ªèŒ„é’Ÿåˆ†å¸ƒæ•°æ®
    private MutableLiveData<List<HighPriorityTask>> highPriorityTasks;  // é«˜ä¼˜å…ˆçº§ä»»åŠ¡
    private MutableLiveData<List<LongestDurationTask>> longestTasks;    // è€—æ—¶æœ€é•¿ä»»åŠ¡
    private MutableLiveData<List<Suggestion>> suggestions;             // æ™ºèƒ½å»ºè®®
    
    // åŠ è½½çŠ¶æ€ç®¡ç†
    private MutableLiveData<Boolean> isLoading;      // åŠ è½½çŠ¶æ€
    private MutableLiveData<String> errorMessage;    // é”™è¯¯ä¿¡æ¯
}
```

### 2. æ•°æ®ç»‘å®šå…³ç³»

| ViewModelæ•°æ® | UIç»„ä»¶ | æ›´æ–°æ–¹æ³• |
|--------------|--------|----------|
| `kpiData` | KPIå¡ç‰‡åŒºåŸŸ | `updateKpiUI()` |
| `taskTrendData` | æŠ˜çº¿å›¾ | `updateLineChart()` |
| `quadrantData` | é¥¼å›¾ | `updatePieChart()` |
| `pomodoroData` | æŸ±çŠ¶å›¾ | `updateBarChart()` |
| `highPriorityTasks` | é«˜ä¼˜å…ˆçº§ä»»åŠ¡åˆ—è¡¨ | `updateHighPriorityTasks()` |
| `longestTasks` | è€—æ—¶ä»»åŠ¡åˆ—è¡¨ | `updateLongestDurationTasks()` |
| `suggestions` | å»ºè®®æ¨¡å— | `updateSuggestions()` |
| `isLoading` | ä¸‹æ‹‰åˆ·æ–°çŠ¶æ€ | `swipeRefreshLayout.setRefreshing()` |
| `errorMessage` | Toastæç¤º | `Toast.makeText()` |

## ğŸ”„ æ•°æ®æµç®¡ç†

### 1. æ•°æ®åŠ è½½æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·æ“ä½œ] --> B{æ“ä½œç±»å‹}
    B -->|æ—¶é—´èŒƒå›´åˆ‡æ¢| C[setTimeRange()]
    B -->|ä¸‹æ‹‰åˆ·æ–°| D[refreshAllData()]
    C --> E[loadAllData()]
    D --> E
    E --> F[è®¾ç½®LoadingçŠ¶æ€]
    F --> G[æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ500ms]
    G --> H[ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®]
    H --> I[æ›´æ–°æ‰€æœ‰LiveData]
    I --> J[UIè‡ªåŠ¨æ›´æ–°]
    J --> K[æ¸…é™¤LoadingçŠ¶æ€]
```

### 2. æ ¸å¿ƒæ–¹æ³•å®ç°

```java
/**
 * ç»Ÿä¸€çš„æ•°æ®åŠ è½½å…¥å£
 */
private void loadAllData(String timeRange) {
    isLoading.setValue(true);
    errorMessage.setValue(null);
    
    try {
        // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
        new Handler(Looper.getMainLooper()).postDelayed(() -> {
            try {
                loadKpiData(timeRange);                // åŠ è½½KPIæ•°æ®
                loadChartDataSeparately(timeRange);    // åŠ è½½å›¾è¡¨æ•°æ®
                loadTaskAnalysisDataSeparately(timeRange); // åŠ è½½ä»»åŠ¡åˆ†ææ•°æ®
                
                isLoading.setValue(false);
            } catch (Exception e) {
                errorMessage.setValue("æ•°æ®åŠ è½½å¤±è´¥: " + e.getMessage());
                isLoading.setValue(false);
            }
        }, 500);
        
    } catch (Exception e) {
        errorMessage.setValue("æ•°æ®åŠ è½½å¤±è´¥: " + e.getMessage());
        isLoading.setValue(false);
    }
}
```

## ğŸ“… æ—¶é—´èŒƒå›´æ•°æ®å·®å¼‚

### 1. ä¸åŒæ—¶é—´èŒƒå›´çš„æ•°æ®ç‰¹å¾

| æ—¶é—´èŒƒå›´ | å®Œæˆä»»åŠ¡æ•° | ç•ªèŒ„é’Ÿæ•° | å®Œæˆç‡ | é‡è¦æ€§è¯„åˆ† |
|---------|-----------|----------|--------|-----------|
| ä»Šæ—¥ | 5-19ä¸ª | 2-9ä¸ª | 60-100% | 3.0-5.0 |
| æœ¬å‘¨ | 35-84ä¸ª | 15-39ä¸ª | 70-100% | 3.5-5.0 |
| æœ¬æœˆ | 120-299ä¸ª | 60-159ä¸ª | 75-100% | 3.8-5.0 |
| è‡ªå®šä¹‰ | 80-199ä¸ª | 40-119ä¸ª | 65-100% | 3.2-5.0 |

### 2. æ—¶é—´èŒƒå›´åˆ‡æ¢å®ç°

```java
public void setTimeRange(String timeRange) {
    if (!timeRange.equals(currentTimeRange)) {
        this.currentTimeRange = timeRange;
        loadAllData(timeRange);  // è§¦å‘æ•°æ®é‡æ–°åŠ è½½
    }
}
```

### 3. UIæ—¶é—´èŒƒå›´ç­›é€‰å™¨

```java
private void setupTimeRangeChips() {
    chipGroupTime.setOnCheckedStateChangeListener((group, checkedIds) -> {
        if (!checkedIds.isEmpty()) {
            int checkedId = checkedIds.get(0);
            String timeRange = getTimeRangeFromChipId(checkedId);
            viewModel.setTimeRange(timeRange);  // è§¦å‘ViewModelæ›´æ–°
        }
    });
}
```

## ğŸ”„ ä¸‹æ‹‰åˆ·æ–°æœºåˆ¶

### 1. SwipeRefreshLayouté›†æˆ

```xml
<androidx.swiperefreshlayout.widget.SwipeRefreshLayout
    android:id="@+id/swipe_refresh_layout"
    android:layout_width="match_parent"
    android:layout_height="match_parent">
    
    <androidx.core.widget.NestedScrollView>
        <!-- ä¸»è¦å†…å®¹ -->
    </androidx.core.widget.NestedScrollView>
    
</androidx.swiperefreshlayout.widget.SwipeRefreshLayout>
```

### 2. ä¸‹æ‹‰åˆ·æ–°é€»è¾‘

```java
private void setupSwipeRefresh() {
    swipeRefreshLayout.setColorSchemeResources(
        R.color.primary_color,
        R.color.accent_color,
        R.color.secondary_color
    );
    
    swipeRefreshLayout.setOnRefreshListener(() -> {
        viewModel.refreshAllData();  // è§¦å‘æ•°æ®åˆ·æ–°
    });
}
```

### 3. åŠ è½½çŠ¶æ€ç»‘å®š

```java
// è§‚å¯ŸåŠ è½½çŠ¶æ€ï¼Œè‡ªåŠ¨æ§åˆ¶åˆ·æ–°åŠ¨ç”»
viewModel.getIsLoading().observe(getViewLifecycleOwner(), isLoading -> {
    swipeRefreshLayout.setRefreshing(isLoading);
});
```

## ğŸ“‹ æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆç­–ç•¥

### 1. KPIæ•°æ®ç”Ÿæˆ

```java
private StatisticsData generateKpiData(String timeRange) {
    Random random = new Random();
    
    switch (timeRange) {
        case "today":
            return new StatisticsData(
                5 + random.nextInt(15),          // ä»Šæ—¥å®Œæˆä»»åŠ¡æ•°
                2 + random.nextInt(8),           // ä»Šæ—¥ç•ªèŒ„é’Ÿæ•°
                60 + random.nextFloat() * 40,    // ä»Šæ—¥å®Œæˆç‡
                3.0f + random.nextFloat() * 2.0f // å¹³å‡é‡è¦æ€§
            );
        // ... å…¶ä»–æ—¶é—´èŒƒå›´
    }
}
```

### 2. å›¾è¡¨æ•°æ®ç”Ÿæˆ

```java
// ä»»åŠ¡å®Œæˆè¶‹åŠ¿ï¼ˆæœ€è¿‘7å¤©ï¼‰
private List<CompletionTrend> generateCompletionTrendData(String timeRange) {
    List<CompletionTrend> trends = new ArrayList<>();
    SimpleDateFormat dateFormat = new SimpleDateFormat("MM/dd", Locale.getDefault());
    Calendar calendar = Calendar.getInstance();
    
    for (int i = 6; i >= 0; i--) {
        calendar.add(Calendar.DAY_OF_YEAR, -i);
        String date = dateFormat.format(calendar.getTime());
        int completedTasks = 3 + random.nextInt(12);
        trends.add(new CompletionTrend(date, completedTasks));
        calendar = Calendar.getInstance();
    }
    
    return trends;
}
```

### 3. ä»»åŠ¡åˆ—è¡¨æ•°æ®ç”Ÿæˆ

```java
// é«˜ä¼˜å…ˆçº§ä»»åŠ¡ç”Ÿæˆ
private List<HighPriorityTask> generateHighPriorityTasks() {
    String[] taskNames = {
        "å®Œæˆé¡¹ç›®å­£åº¦æŠ¥å‘Š", "å¤„ç†å®¢æˆ·ç´§æ€¥é—®é¢˜", "å‡†å¤‡æ˜å¤©çš„é‡è¦ä¼šè®®",
        "ä¿®å¤ç³»ç»Ÿå®‰å…¨æ¼æ´", "å®Œæˆäº§å“åŠŸèƒ½è®¾è®¡", "å¤„ç†å›¢é˜Ÿå†²çªé—®é¢˜"
    };
    
    List<HighPriorityTask> tasks = new ArrayList<>();
    for (int i = 0; i < Math.min(5, taskNames.length); i++) {
        int importance = 8 + random.nextInt(3);  // 8-10
        int urgency = 8 + random.nextInt(3);     // 8-10
        boolean isCompleted = random.nextBoolean();
        
        tasks.add(new HighPriorityTask(taskNames[i], importance, urgency, isCompleted, "task_" + i));
    }
    
    return tasks;
}
```

## ğŸ¨ UIæ•°æ®ç»‘å®šå®ç°

### 1. KPIæ•°æ®ç»‘å®š

```java
private void updateKpiUI(StatisticsData data) {
    if (data == null) return;
    
    tvCompletedTasksCount.setText(String.valueOf(data.getCompletedTasksToday()));
    tvPomodoroCount.setText(String.valueOf(data.getPomodoroCountWeek()));
    
    DecimalFormat df = new DecimalFormat("#.#");
    String completionRateText = df.format(data.getCompletionRateWeek()) + "%";
    tvCompletionRate.setText(completionRateText);
    progressCompletionRate.setProgress((int) data.getCompletionRateWeek());
    
    String avgImportanceText = df.format(data.getAvgImportanceScore());
    tvAvgImportance.setText(avgImportanceText);
}
```

### 2. å›¾è¡¨æ•°æ®ç»‘å®š

```java
private void updateLineChart(List<CompletionTrend> trends) {
    if (trends == null || trends.isEmpty()) return;
    
    List<Entry> entries = new ArrayList<>();
    List<String> labels = new ArrayList<>();
    
    for (int i = 0; i < trends.size(); i++) {
        CompletionTrend trend = trends.get(i);
        entries.add(new Entry(i, trend.getCompletedTasks()));
        labels.add(trend.getDate());
    }
    
    LineDataSet dataSet = new LineDataSet(entries, "ä»»åŠ¡å®Œæˆæ•°");
    // è®¾ç½®å›¾è¡¨æ ·å¼...
    
    LineData lineData = new LineData(dataSet);
    lineChartCompletionTrend.setData(lineData);
    lineChartCompletionTrend.invalidate();
}
```

### 3. åˆ—è¡¨æ•°æ®ç»‘å®š

```java
private void updateHighPriorityTasks(List<HighPriorityTask> tasks) {
    if (tasks == null || tasks.isEmpty()) {
        rvHighPriorityTasks.setVisibility(View.GONE);
        tvNoHighPriorityTasks.setVisibility(View.VISIBLE);
    } else {
        rvHighPriorityTasks.setVisibility(View.VISIBLE);
        tvNoHighPriorityTasks.setVisibility(View.GONE);
        highPriorityTaskAdapter.updateTasks(tasks);
    }
}
```

## ğŸš¦ çŠ¶æ€ç®¡ç†å’Œé”™è¯¯å¤„ç†

### 1. åŠ è½½çŠ¶æ€ç®¡ç†

```java
// ViewModelä¸­
private MutableLiveData<Boolean> isLoading = new MutableLiveData<>(false);

// å¼€å§‹åŠ è½½
isLoading.setValue(true);

// åŠ è½½å®Œæˆ
isLoading.setValue(false);

// Fragmentä¸­è§‚å¯Ÿ
viewModel.getIsLoading().observe(getViewLifecycleOwner(), isLoading -> {
    swipeRefreshLayout.setRefreshing(isLoading);
});
```

### 2. é”™è¯¯å¤„ç†æœºåˆ¶

```java
// ViewModelä¸­
private MutableLiveData<String> errorMessage = new MutableLiveData<>();

// è®¾ç½®é”™è¯¯ä¿¡æ¯
errorMessage.setValue("æ•°æ®åŠ è½½å¤±è´¥: " + e.getMessage());

// Fragmentä¸­è§‚å¯Ÿ
viewModel.getErrorMessage().observe(getViewLifecycleOwner(), errorMessage -> {
    if (errorMessage != null && !errorMessage.isEmpty()) {
        Toast.makeText(getContext(), errorMessage, Toast.LENGTH_LONG).show();
    }
});
```

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### 1. æ—¶é—´èŒƒå›´åˆ‡æ¢
```java
// ç”¨æˆ·ç‚¹å‡»"æœ¬å‘¨"ç­›é€‰å™¨
chipWeek.setOnClickListener(v -> {
    viewModel.setTimeRange("week");
    // è‡ªåŠ¨è§¦å‘æ•°æ®åˆ·æ–°å’ŒUIæ›´æ–°
});
```

### 2. æ‰‹åŠ¨åˆ·æ–°æ•°æ®
```java
// ç”¨æˆ·ä¸‹æ‹‰åˆ·æ–°
swipeRefreshLayout.setOnRefreshListener(() -> {
    viewModel.refreshAllData();
    // è‡ªåŠ¨è§¦å‘åŠ è½½çŠ¶æ€æ›´æ–°å’Œæ•°æ®åˆ·æ–°
});
```

### 3. è§‚å¯Ÿç‰¹å®šæ•°æ®å˜åŒ–
```java
// åªè§‚å¯ŸKPIæ•°æ®å˜åŒ–
viewModel.getKpiData().observe(this, kpiData -> {
    updateKpiUI(kpiData);
});

// åªè§‚å¯Ÿå›¾è¡¨æ•°æ®å˜åŒ–
viewModel.getTaskTrendData().observe(this, trendData -> {
    updateLineChart(trendData);
});
```

## ğŸ¯ ä¼˜åŠ¿å’Œç‰¹ç‚¹

### 1. æ•°æ®ç»‘å®šä¼˜åŠ¿
- **ç»†ç²’åº¦æ§åˆ¶**ï¼šæ¯ä¸ªUIæ¨¡å—å¯ç‹¬ç«‹è§‚å¯Ÿå¯¹åº”æ•°æ®
- **è‡ªåŠ¨æ›´æ–°**ï¼šæ•°æ®å˜åŒ–æ—¶UIè‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨
- **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨å¼ºç±»å‹LiveDataï¼Œé¿å…ç±»å‹é”™è¯¯
- **ç”Ÿå‘½å‘¨æœŸå®‰å…¨**ï¼šè‡ªåŠ¨å¤„ç†Fragmentç”Ÿå‘½å‘¨æœŸ

### 2. çŠ¶æ€ç®¡ç†ä¼˜åŠ¿
- **ç»Ÿä¸€çŠ¶æ€**ï¼šæ‰€æœ‰é¡µé¢çŠ¶æ€é›†ä¸­åœ¨ViewModelä¸­ç®¡ç†
- **çŠ¶æ€æŒä¹…åŒ–**ï¼šViewModelåœ¨é…ç½®å˜åŒ–æ—¶ä¿æŒçŠ¶æ€
- **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆæœºåˆ¶
- **åŠ è½½çŠ¶æ€**ï¼šç»Ÿä¸€çš„åŠ è½½çŠ¶æ€ç®¡ç†å’ŒUIåé¦ˆ

### 3. æ¨¡æ‹Ÿæ•°æ®ä¼˜åŠ¿
- **çœŸå®æ€§**ï¼šæ¨¡æ‹Ÿæ•°æ®è´´è¿‘çœŸå®ä½¿ç”¨åœºæ™¯
- **å¯è°ƒè¯•æ€§**ï¼šä¾¿äºUIè°ƒè¯•å’ŒåŠŸèƒ½éªŒè¯
- **å·®å¼‚åŒ–**ï¼šä¸åŒæ—¶é—´èŒƒå›´å±•ç¤ºä¸åŒçš„æ•°æ®ç‰¹å¾
- **éšæœºæ€§**ï¼šæ¯æ¬¡åˆ·æ–°ç”Ÿæˆä¸åŒæ•°æ®ï¼Œæµ‹è¯•UIé€‚åº”æ€§

## ğŸ“š æ€»ç»“

æœ¬å®ç°æä¾›äº†å®Œæ•´çš„æ•°æ®ç»‘å®šå’ŒçŠ¶æ€ç®¡ç†è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

1. **å®Œå–„çš„ViewModelæ¶æ„**ï¼šç»†åˆ†æ•°æ®ç®¡ç†ï¼Œç»Ÿä¸€çŠ¶æ€æ§åˆ¶
2. **å“åº”å¼æ•°æ®ç»‘å®š**ï¼šLiveDataè§‚å¯Ÿè€…æ¨¡å¼ï¼Œè‡ªåŠ¨UIæ›´æ–°
3. **æ™ºèƒ½æ—¶é—´èŒƒå›´åˆ‡æ¢**ï¼šä¸åŒæ—¶é—´æ®µå±•ç¤ºå·®å¼‚åŒ–æ•°æ®
4. **æµç•…çš„ä¸‹æ‹‰åˆ·æ–°**ï¼šå®Œæ•´çš„åŠ è½½çŠ¶æ€åé¦ˆ
5. **å¥å£®çš„é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
6. **é«˜è´¨é‡æ¨¡æ‹Ÿæ•°æ®**ï¼šè´´è¿‘çœŸå®åœºæ™¯çš„æ•°æ®ç”Ÿæˆ

è¿™ä¸ªå®ç°ä¸ºç»Ÿè®¡é¡µé¢æä¾›äº†å¼ºå¤§çš„æ•°æ®ç®¡ç†åŸºç¡€ï¼Œç¡®ä¿äº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒå’Œå¼€å‘ä½“éªŒã€‚
